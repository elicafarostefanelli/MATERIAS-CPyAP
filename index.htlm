<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Cursado</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        // (Firebase imports will be placed here by the script logic)
    </script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para checkboxes deshabilitados */
        input[type="checkbox"]:disabled+label {
            color: #9ca3af; /* text-gray-400 */
            cursor: not-allowed;
        }

        .subject-item:has(input[type="checkbox"]:disabled) {
            background-color: #f3f4f6; /* bg-gray-100 */
            opacity: 0.7;
        }
    </style>
</head>

<body class="bg-green-700"> <!-- Fondo verde oscuro -->

    <div id="app" class="max-w-lg mx-auto bg-neutral-50 shadow-lg rounded-lg my-10 p-6 transition-all duration-300">
        
        <!-- Título con imagen -->
        <div class="flex items-center justify-center mb-6">
            <!-- PUEDES CAMBIAR EL 'src' por tu propia imagen -->
            <img src="https://placehold.co/40x40/166534/ffffff?text=G" alt="logo" class="h-10 w-10 mr-3 rounded-md">
            <h1 class="text-3xl font-bold text-green-700">Guía de Cursado</h1> <!-- <-- CAMBIADO a green-700 -->
        </div>


        <!-- Loading and Auth State -->
        <div id="loading-state" class="text-center text-gray-500 mb-4">
            <p>Cargando datos...</p>
        </div>

        <!-- Auth Container -->
        <div id="auth-container" class="mb-4 text-center">
            <!-- Logged Out State -->
            <div id="logged-out-state">
                <p class="text-gray-600 mb-4">Inicia sesión para guardar tu progreso.</p>
                <button id="google-login-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                    <svg class="w-5 h-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.65-3.657-11.303-8H2.697v6.46C6.045,39.512,14.31,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.23,4.14-4.082,5.571l6.19,5.238C39.957,34.812,44,29.982,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                    Iniciar sesión con Google
                </button>
            </div>
            <!-- Logged In State (populated by JS) -->
            <div id="logged-in-state" class="hidden">
                <p class="text-gray-700 mb-2">Conectado como: <strong id="user-name"></strong> (<span id="user-email"></span>)</p>
                <button id="logout-btn" class="text-sm text-red-500 hover:underline">
                    Cerrar Sesión
                </button>
            </div>
        </div>
        
        <div id="auth-state" class="text-center text-xs text-gray-400 mb-4 break-words">
            Conectando...
        </div>

        <!-- Progress Section -->
        <div id="progress-container" class="mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Tu Avance</h2>
            <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-medium text-green-700" id="progress-text">0%</span> <!-- <-- CAMBIADO a green-700 -->
                <span class="text-sm text-gray-500" id="progress-count">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-green-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div> <!-- <-- CAMBIADO a green-600 -->
            </div>
        </div>

        <!-- Curriculum Section -->
        <div id="curriculum-container" class="space-y-6">
            <!-- Los semestres y materias se renderizarán aquí -->
        </div>

    </div>

    <!-- Firebase SDKs (módulo) -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            GoogleAuthProvider, // <-- Añadido
            signInWithPopup,    // <-- Añadido
            signOut             // <-- Añadido
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURACIÓN DEL CURRÍCULO ---
        // ¡Edita esta sección con tus materias, años y correlatividades!
        // Usa los 'id' para enlazar las correlatividades.
        const CURRICULUM = [
            // --- Año 1 (6 materias) ---
            {
                year: 1,
                semester: 1,
                name: "Año 1 - Cuatrimestre 1",
                subjects: [
                    { id: '101', name: 'Estado, Sociedad y Política', type: 'Promocional', prerequisites: [] },
                    { id: '102', name: 'Historia Institucional', type: 'Promocional', prerequisites: [] },
                    { id: '103', name: 'Instituciones del Derecho', type: 'Regular', prerequisites: [] },
                ]
            },
            {
                year: 1,
                semester: 2,
                name: "Año 1 - Cuatrimestre 2",
                subjects: [
                    { id: '104', name: 'Sociología General', type: 'Promocional', prerequisites: [] },
                    { id: '105', name: 'Relaciones Internacionales', type: 'Promocional', prerequisites: [] },
                    { id: '106', name: 'Administración General', type: 'Regular', prerequisites: [] },
                ]
            },
            // --- Año 2 (6 materias) ---
            {
                year: 2,
                semester: 1,
                name: "Año 2 - Cuatrimestre 1",
                subjects: [
                    { id: '201', name: 'Análisis Cuantitativo', type: 'Promocional', prerequisites: [] },
                    { id: '202', name: 'Doctrinas e Ideas I', type: 'Regular', prerequisites: [] },
                    { id: '203', name: 'Derecho Constitucional', type: 'Regular', prerequisites: ['103'] },
                ]
            },
            {
                year: 2,
                semester: 2,
                name: "Año 2 - Cuatrimestre 2",
                subjects: [
                    { id: '204', name: 'Administración de RR.HH.', type: 'Regular', prerequisites: ['106'] },
                    { id: '205', name: 'Epistemología de las C.S.', type: 'Regular', prerequisites: [] },
                    { id: '206', name: 'Teoría Económica I', type: 'Regular', prerequisites: ['201'] },
                ]
            },
            // --- Año 3 (5 materias) ---
            {
                year: 3,
                semester: 1,
                name: "Año 3 - Cuatrimestre 1",
                subjects: [
                    { id: '301', name: 'Teoría Económica II', type: 'Regular', prerequisites: ['206'] },
                    { id: '302', name: 'Derecho Administrativo', type: 'Regular', prerequisites: ['203'] },
                    { id: '303', name: 'Metodología de la Investigación. (Anual)', type: 'Promocional', prerequisites: [] },
                ]
            },
            {
                year: 3,
                semester: 2,
                name: "Año 3 - Cuatrimestre 2",
                subjects: [
                    { id: '304', name: 'Doctrinas e Ideas II', type: 'Regular', prerequisites: ['202'] },
                    { id: '305', name: 'Teoría Política I', type: 'Promocional', prerequisites: ['101'] }, // <-- ARREGLADO
                    { id: '303', name: 'Metodología de la Investigación. (Anual)', type: 'Promocional', prerequisites: [] }, // <-- Materia anual añadida
                ]
            },
            // --- Año 4 (6 materias) ---
            {
                year: 4,
                semester: 1,
                name: "Año 4 - Cuatrimestre 1",
                subjects: [
                    { id: '401', name: 'Administración Ambiental', type: 'Promocional', prerequisites: ['302'] },
                    { id: '402', name: 'Organización y Gestión del Estado', type: 'Promocional', prerequisites: ['106', '302'] }, // <-- ARREGLADO (coma añadida)
                    { id: '403', name: 'Teoría Política II', type: 'Promocional', prerequisites: ['305'] },
                ]
            },
            {
                year: 4,
                semester: 2,
                name: "Año 4 - Cuatrimestre 2",
                subjects: [
                    { id: '404', name: 'Administración Financiera', type: 'Regular', prerequisites: ['201'] },
                    { id: '405', name: 'Política Económica', type: 'Regular', prerequisites: ['301'] },
                    { id: '406', name: 'Ideas Políticas y Sociales Americanas', type: 'Promocional', prerequisites: ['102'] },
                ]
            },
            // --- Año 5 (4 materias) ---
            {
                year: 5,
                semester: 1,
                name: "Año 5 - Cuatrimestre 1",
                subjects: [
                    { id: '501', name: 'Taller de Tesina', type: 'Promocional', prerequisites: [] },
                    { id: '502', name: 'Análisis Política', type: 'Promocional', prerequisites: [] }, // <-- CORREGIDO (eliminado 't:')
                    { id: '503', name: 'Análisis Administrativo (Anual)', type: 'Promocional', prerequisites: ['303'] },
                ]
            },
            // --- Año 5 - Cuatrimestre 2 (para materia anual) ---
            {
                year: 5,
                semester: 2,
                name: "Año 5 - Cuatrimestre 2",
                subjects: [
                    { id: '503', name: 'Análisis Administrativo (Anual)', type: 'Promocional', prerequisites: ['303'] }, // <-- Materia anual (CORREGIDO)
                    { id: '504', name: 'Sistemas de Control de Gestión', type: 'Promocional', prerequisites: ['404'] }, // <-- Movida al 2do cuatri
                ]
            },
            // --- Requisitos Adicionales ---
            {
                year: 6, // <-- Cambiado a año 6 para separarlo
                semester: 1,
                name: "Requisitos Finales y Adicionales",
                subjects: [
                    { id: '901', name: 'Idioma (Inglés o Francés)', type: 'Promocional', prerequisites: [] },
                    { id: '902', name: 'Computación', type: 'Promocional con examen final', prerequisites: [] },
                    { id: '903', name: 'Optativa I', type: 'Promocional sin examen final', prerequisites: [] },
                    { id: '904', name: 'Optativa II', type: 'Promocional sin examen final', prerequisites: [] },
                    { id: '905', name: 'Optativa III', type: 'Promocional sin examen final', prerequisites: [] },
                    { id: '999', name: 'Trabajo Final de Grado', type: '', prerequisites: [], isTFG: true }, // <-- Marcador TFG
                ]
            }
        ];
        // --- FIN DE LA CONFIGURACIÓN ---

        // --- 2. LÓGICA DE LA APLICACIÓN ---

        // Configuración de Firebase (se inyectan automáticamente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Habilitar logs para debugging
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            document.getElementById('loading-state').textContent = "Error al conectar con la base de datos.";
            // Se eliminó el 'return' ilegal de aquí
        }

        // Referencias al DOM
        const loadingState = document.getElementById('loading-state');
        const authState = document.getElementById('auth-state');
        
        // Nuevas referencias de autenticación
        const authContainer = document.getElementById('auth-container');
        const loggedOutState = document.getElementById('logged-out-state');
        const loggedInState = document.getElementById('logged-in-state');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');

        const progressContainer = document.getElementById('progress-container');
        const progressText = document.getElementById('progress-text');
        const progressCount = document.getElementById('progress-count');
        const progressBar = document.getElementById('progress-bar');
        const curriculumContainer = document.getElementById('curriculum-container');

        // Estado de la aplicación
        let currentUserId = null;
        let approvedSubjects = new Set();
        let progressDocRef = null;
        let unsubscribeProgress = null;

        // Calcular total de materias y crear un mapa para búsqueda rápida
        const allSubjects = new Map();
        CURRICULUM.forEach(semester => {
            semester.subjects.forEach(subject => {
                allSubjects.set(subject.id, subject); // El mapa garantiza IDs únicos
            });
        });

        // Calcular el total de materias (excluyendo TFG) desde el mapa único
        let totalSubjects = 0;
        allSubjects.forEach(subject => {
            if (subject.isTFG !== true) { // No contar TFG para el %
                totalSubjects++;
            }
        });

        // --- NUEVO: Construir mapa de dependencias (habilita a...) ---
        const dependencyMap = new Map();
        allSubjects.forEach((subject, subjectId) => {
            subject.prerequisites.forEach(prereqId => {
                const dependents = dependencyMap.get(prereqId) || [];
                if (!dependents.includes(subject.name)) { // Evitar duplicados por materias anuales
                    dependents.push(subject.name);
                    dependencyMap.set(prereqId, dependents);
                }
            });
        });
        // --- FIN NUEVO ---


        // --- 3. LÓGICA DE AUTENTICACIÓN Y DATOS ---

        // 1. Configurar Autenticación
        async function setupAuth() {
            const provider = new GoogleAuthProvider(); // Proveedor de Google

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Usuario está logueado
                    currentUserId = user.uid;
                    
                    // Actualizar UI a estado "logueado"
                    userNameEl.textContent = user.displayName || 'Usuario';
                    userEmailEl.textContent = user.email || 'Sin email';
                    loggedInState.style.display = 'block';
                    loggedOutState.style.display = 'none';
                    
                    authState.textContent = `Autenticado como: ${user.email} (UID: ${currentUserId})`;

                    // Configurar el listener de datos
                    setupProgressListener();
                } else {
                    // Usuario no está logueado
                    currentUserId = null;
                    authState.textContent = "No autenticado. Por favor, inicia sesión.";
                    
                    // Actualizar UI a estado "deslogueado"
                    loggedInState.style.display = 'none';
                    loggedOutState.style.display = 'block';
                    loadingState.style.display = 'none'; // No hay datos que cargar
                    progressContainer.style.display = 'none'; // Ocultar progreso
                    curriculumContainer.innerHTML = ''; // Limpiar materias
                    
                    if (unsubscribeProgress) unsubscribeProgress();
                }
            });

            // Manejador para el botón de Login
            googleLoginBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged se encargará del resto
                } catch (error) {
                    console.error("Error al iniciar sesión con Google:", error);
                    authState.textContent = "Error al iniciar sesión.";
                }
            });

            // Manejador para el botón de Logout
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged se encargará de limpiar la UI
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                }
            });

            // Manejar token inicial (si existe, para el entorno de Canvas)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error de autenticación con token:", error);
                    // Si falla el token, no hacer nada, dejar que el usuario inicie sesión
                }
            }
            // Eliminamos el signInAnonymously
        }

        // 2. Configurar listener de Firestore
        function setupProgressListener() {
            if (!currentUserId) return;

            // Limpiar listener anterior si existe
            if (unsubscribeProgress) unsubscribeProgress();

            // Referencia al documento privado del usuario
            // Usamos un solo documento 'progress' para guardar el array de aprobadas
            progressDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/progress/main`);

            // Escuchar cambios en el documento
            unsubscribeProgress = onSnapshot(progressDocRef, (doc) => {
                loadingState.style.display = 'none';
                progressContainer.style.display = 'block';

                if (doc.exists()) {
                    // Si el documento existe, cargar las materias aprobadas
                    const data = doc.data();
                    approvedSubjects = new Set(data.approvedSubjects || []);
                } else {
                    // Documento no existe, es la primera vez
                    approvedSubjects = new Set();
                }
                
                // Renderizar la UI con los datos actualizados
                renderCurriculum();

            }, (error) => {
                console.error("Error escuchando datos:", error);
                loadingState.textContent = "Error al cargar datos.";
            });
        }

        // 3. Renderizar la UI
        function renderCurriculum() {
            if (totalSubjects === 0) return;

            // Limpiar contenedor
            curriculumContainer.innerHTML = '';

            // Calcular progreso
            const approvedCount = approvedSubjects.size;
            const percent = Math.round((approvedCount / totalSubjects) * 100);
            
            progressText.textContent = `${percent}%`;
            progressCount.textContent = `${approvedCount} / ${totalSubjects}`;
            progressBar.style.width = `${percent}%`;

            // Renderizar semestres y materias
            CURRICULUM.forEach(semester => {
                const semesterEl = document.createElement('div');
                semesterEl.className = 'mb-6';
                
                const titleEl = document.createElement('h2');
                titleEl.className = 'text-xl font-semibold text-gray-700 mb-4 border-b pb-2';
                titleEl.textContent = semester.name;
                semesterEl.appendChild(titleEl);

                const subjectsListEl = document.createElement('div');
                subjectsListEl.className = 'space-y-4';

                semester.subjects.forEach(subject => {
                    const isApproved = approvedSubjects.has(subject.id);
                    const prereqsMet = checkPrerequisites(subject);

                    // Construir string de correlatividades
                    const prereqNames = subject.prerequisites
                        .map(id => allSubjects.get(id)?.name || 'N/A')
                        .join(', ');

                    // --- NUEVO: Obtener materias que esta habilita ---
                    const dependentSubjects = dependencyMap.get(subject.id) || [];
                    const dependentNames = dependentSubjects.join(', ');
                    
                    // Ocultar la sección "Habilita a:" si no habilita a ninguna
                    const dependentHtml = dependentNames ? `
                        <p>
                            <strong>Habilita a:</strong> 
                            <span class="text-blue-600">
                                ${dependentNames}
                            </span>
                        </p>
                    ` : '';
                    // --- FIN NUEVO ---


                    const itemEl = document.createElement('div');
                    itemEl.className = 'subject-item border rounded-lg p-4 shadow-sm transition-all';
                    
                    itemEl.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    id="subject-${subject.id}" 
                                    data-id="${subject.id}" 
                                    class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                    ${isApproved ? 'checked' : ''}
                                    ${!prereqsMet && !isApproved ? 'disabled' : ''}
                                >
                                <label for="subject-${subject.id}" class="ml-3 block text-lg font-medium text-gray-900">
                                    ${subject.name}
                                </label>
                            </div>
                        </div>
                        <div class="mt-3 pl-8 text-sm text-gray-600 space-y-1">
                            <p><strong>Condición:</strong> ${subject.type || 'Regular'}</p>
                            <p>
                                <strong>Requiere:</strong> 
                                <span class="${prereqsMet ? 'text-green-600' : 'text-red-600'}">
                                    ${prereqNames || 'Ninguna'}
                                </span>
                            </p>
                            ${dependentHtml} <!-- <-- Añadido -->
                        </div>
                    `;
                    subjectsListEl.appendChild(itemEl);
                });

                semesterEl.appendChild(subjectsListEl);
                curriculumContainer.appendChild(semesterEl);
            });
        }

        // 4. Helper para chequear correlatividades
        function checkPrerequisites(subject) {
            if (subject.prerequisites.length === 0) {
                return true; // No tiene requisitos
            }
            // Chequear si *todas* las correlatividades están en el Set de aprobadas
            return subject.prerequisites.every(prereqId => approvedSubjects.has(prereqId));
        }

        // 5. Manejador de eventos para aprobar/desaprobar
        async function handleSubjectToggle(e) {
            if (e.target.type !== 'checkbox') return;

            const subjectId = e.target.dataset.id;
            const isChecked = e.target.checked;

            if (!subjectId) return;

            // Actualizar el estado local
            if (isChecked) {
                approvedSubjects.add(subjectId);
            } else {
                approvedSubjects.delete(subjectId);
                // Lógica de "desaprobación en cascada":
                // Si desapruebo una materia, debo desaprobar las que dependen de ella.
                const toRemove = new Set();
                
                function findDependents(currentId) {
                    allSubjects.forEach(subj => {
                        if (subj.prerequisites.includes(currentId) && approvedSubjects.has(subj.id)) {
                            toRemove.add(subj.id);
                            findDependents(subj.id); // Buscar recursivamente
                        }
                    });
                }
                
                findDependents(subjectId);
                toRemove.forEach(id => approvedSubjects.delete(id));
            }

            // Actualizar la UI inmediatamente para respuesta rápida
            renderCurriculum();

            // Guardar en Firestore
            if (progressDocRef) {
                try {
                    // Guardamos el Set como un Array
                    await setDoc(progressDocRef, { approvedSubjects: Array.from(approvedSubjects) }, { merge: true });
                } catch (error) {
                    console.error("Error guardando progreso:", error);
                    // Opcional: Revertir el estado local y mostrar un error
                }
            }
        }

        // 6. Asignar el listener de eventos al contenedor
        curriculumContainer.addEventListener('change', handleSubjectToggle);

        // --- 3. INICIAR LA APP ---
        setupAuth();

    </script>
</body>

</html>
